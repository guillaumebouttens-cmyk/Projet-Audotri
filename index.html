<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audotri - Application SharePoint</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MSAL.js via CDN -->
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .tab-active {
            border-bottom: 3px solid #2563eb;
            color: #1e40af;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .modal-overlay {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        .table-container {
            max-height: calc(100vh - 280px);
            overflow: auto;
        }

        th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8fafc;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen text-slate-800 font-sans">

    <!-- Header / Nav -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2.5 rounded-xl shadow-lg shadow-blue-200">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-black text-slate-900 leading-tight">Audotri <span
                                class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded ml-1 font-mono">v1.1</span>
                        </h1>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Production ACI</p>
                    </div>
                </div>
                <div id="auth-controls">
                    <button id="login-btn" onclick="signIn()"
                        class="hidden bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-semibold transition-all shadow-md active:scale-95">
                        Connexion
                    </button>
                    <div id="user-info" class="hidden flex items-center gap-4">
                        <div class="hidden sm:block text-right">
                            <p id="username" class="text-sm font-bold text-slate-700"></p>
                            <p class="text-[10px] text-slate-400">Session Active</p>
                        </div>
                        <button onclick="signOut()" class="p-2 text-slate-400 hover:text-red-500 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

        <!-- Loading Screen -->
        <div id="loading-overlay"
            class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
            <div class="relative w-20 h-20">
                <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin">
                </div>
            </div>
            <p class="mt-4 text-slate-500 font-medium animate-pulse">Initialisation de la session...</p>
        </div>

        <!-- App Content -->
        <div id="app-content" class="hidden space-y-6">

            <!-- Tabs Menu -->
            <div class="flex border-b border-gray-200 gap-6 overflow-x-auto no-scrollbar pb-0.5">
                <button onclick="switchTab('tab-ramasses')" id="btn-ramasses"
                    class="pb-4 text-sm font-bold transition-all tab-active whitespace-nowrap">Ramasses</button>
                <button onclick="switchTab('tab-clients')" id="btn-clients"
                    class="pb-4 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all whitespace-nowrap">Clients</button>
                <button onclick="switchTab('tab-production')" id="btn-production"
                    class="pb-4 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all whitespace-nowrap">Production</button>
                <button onclick="switchTab('tab-departs')" id="btn-departs"
                    class="pb-4 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all whitespace-nowrap">Départs</button>
                <button onclick="switchTab('tab-incidents')" id="btn-incidents"
                    class="pb-4 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all whitespace-nowrap">Incidents</button>
            </div>

            <!-- TAB: Ramasses -->
            <div id="tab-ramasses" class="tab-pane space-y-6">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-black text-slate-900 leading-tight">Gestion des Ramasses</h2>
                    <button onclick="openModal('T_Ramasses')"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-2xl font-bold flex items-center gap-2 shadow-lg shadow-blue-100 transition-all active:scale-95 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Nouvelle
                    </button>
                </div>
                <div class="bg-white rounded-3xl overflow-hidden shadow-sm ring-1 ring-slate-100 table-container">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr id="table-head-ramasses"></tr>
                        </thead>
                        <tbody id="table-body-ramasses" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: Clients -->
            <div id="tab-clients" class="tab-pane hidden space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-black text-slate-900 leading-tight">Base Clients</h2>
                    <button onclick="openModal('T_Clients')"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-2xl font-bold flex items-center gap-2 shadow-lg shadow-blue-100 transition-all active:scale-95 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Client
                    </button>
                </div>
                <div class="bg-white rounded-3xl overflow-hidden shadow-sm ring-1 ring-slate-100 table-container">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr id="table-head-clients"></tr>
                        </thead>
                        <tbody id="table-body-clients" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: Production -->
            <div id="tab-production" class="tab-pane hidden space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-black text-slate-900">Suivi Production</h2>
                    <button onclick="openModal('T_Production')"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-2xl font-bold flex items-center gap-2 shadow-lg shadow-blue-100 transition-all active:scale-95 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Balle
                    </button>
                </div>
                <div class="bg-white rounded-3xl overflow-hidden shadow-sm ring-1 ring-slate-100 table-container">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr id="table-head-production"></tr>
                        </thead>
                        <tbody id="table-body-production" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: Départs -->
            <div id="tab-departs" class="tab-pane hidden space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-black text-slate-900">Suivi des Départs</h2>
                    <button onclick="openModal('T_Departs')"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-2xl font-bold flex items-center gap-2 shadow-lg shadow-blue-100 transition-all active:scale-95 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Départ
                    </button>
                </div>
                <div class="bg-white rounded-3xl overflow-hidden shadow-sm ring-1 ring-slate-100 table-container">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr id="table-head-departs"></tr>
                        </thead>
                        <tbody id="table-body-departs" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: Incidents -->
            <div id="tab-incidents" class="tab-pane hidden space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-black text-slate-900">Suivi des Incidents</h2>
                    <button onclick="openModal('T_Incidents')"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-2xl font-bold flex items-center gap-2 shadow-lg shadow-blue-100 transition-all active:scale-95 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Incident
                    </button>
                </div>
                <div class="bg-white rounded-3xl overflow-hidden shadow-sm ring-1 ring-slate-100 table-container">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr id="table-head-incidents"></tr>
                        </thead>
                        <tbody id="table-body-incidents" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Toasts Container -->
    <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-[200] space-y-3">
    </div>

    <!-- CRUD MODAL -->
    <div id="crud-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div
            class="bg-white w-full max-w-2xl rounded-[32px] shadow-2xl relative z-10 flex flex-col max-h-[90vh] overflow-hidden animate-in zoom-in-95 duration-200">
            <!-- Modal Header -->
            <div class="p-8 border-b border-slate-50 flex justify-between items-center">
                <div>
                    <h2 id="modal-title" class="text-2xl font-black text-slate-900">Modifier l'entrée</h2>
                    <p id="modal-subtitle" class="text-sm text-slate-400 font-bold uppercase tracking-wider">T_Ramasses
                    </p>
                </div>
                <button onclick="closeModal()"
                    class="p-3 hover:bg-slate-50 rounded-2xl transition-colors text-slate-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <!-- Modal Body (Dynamic Form) -->
            <div id="modal-body" class="p-8 overflow-y-auto space-y-6">
                <form id="dynamic-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-4">
                    <!-- Fields injected here -->
                </form>
            </div>
            <!-- Modal Footer -->
            <div class="p-8 bg-slate-50/50 flex gap-4">
                <button onclick="closeModal()"
                    class="flex-1 px-8 py-4 bg-white hover:bg-slate-100 text-slate-600 font-black rounded-2xl border border-slate-200 transition-all active:scale-95">
                    Annuler
                </button>
                <button id="modal-save-btn" onclick="saveEntry()"
                    class="flex-[2] px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-2xl shadow-xl shadow-blue-100 transition-all active:scale-95 flex justify-center items-center gap-2">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <script shadow-dom="false">
        /**
         * CONFIGURATION
         */
        const msalConfig = {
            auth: {
                clientId: "88a2375d-4161-41c4-9b21-5f8e881f5ab2",
                authority: "https://login.microsoftonline.com/996167ca-12e4-48a3-92ad-bbd8e5ef4b64",
                redirectUri: window.location.origin + window.location.pathname,
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: true,
            }
        };

        const loginRequest = {
            scopes: ["User.Read", "Files.ReadWrite.All", "Sites.Read.All"]
        };

        const SITE_PATH = "gbsconseil.sharepoint.com:/sites/Audotri";
        const FILE_PATH = "/Application/BDD ACI.xlsx";
        let resolvedGraphBaseUrl = null;

        const myMSALObj = new msal.PublicClientApplication(msalConfig);

        /**
         * CRUD CONFIGURATION
         */
        const TABLE_CONFIG = {
            'T_Clients': {
                title: 'Clients',
                idPrefix: 'CL',
                cols: [
                    { name: 'N° Client', type: 'number', readonly: true },
                    { name: 'Client', type: 'text' },
                    { name: 'Groupe', type: 'text' },
                    { name: 'Adresse1', type: 'text' },
                    { name: 'Adresse2', type: 'text' },
                    { name: 'CP', type: 'text' },
                    { name: 'Localité', type: 'text' },
                    { name: 'Téléphone', type: 'text' },
                    { name: 'Adresse mail', type: 'text' },
                    { name: 'Contrat', type: 'checkbox' },
                    { name: 'Ramasse lundi', type: 'checkbox' },
                    { name: 'Ramasse mardi', type: 'checkbox' },
                    { name: 'Ramasse mercredi', type: 'checkbox' },
                    { name: 'Ramasse jeudi', type: 'checkbox' },
                    { name: 'Ramasse vendredi', type: 'checkbox' }
                ]
            },
            'T_Ramasses': {
                title: 'Ramasses',
                idPrefix: 'RA',
                cols: [
                    { name: 'N° Ramas', type: 'number', readonly: true },
                    { name: 'Date', type: 'date' },
                    { name: 'Famille matière', type: 'text' },
                    { name: 'Client', type: 'select', optionsTable: 'T_Clients', optionLabelIndex: 1 },
                    { name: 'Quantité', type: 'number' },
                    { name: 'Nombre de déplacements', type: 'number', default: 1 },
                    { name: 'nb BB', type: 'number', default: 0 },
                    { name: 'nb BB PSE', type: 'number', default: 0 }
                ]
            },
            'T_Production': {
                title: 'Production',
                idPrefix: 'PR',
                cols: [
                    { name: 'N° Balle', type: 'number', readonly: true },
                    { name: 'Produit', type: 'text' },
                    { name: 'Poids', type: 'number' },
                    { name: 'Date', type: 'date' },
                    { name: 'N°société', type: 'text', default: 'Audotri' },
                    { name: 'N° Départ', type: 'number' },
                    { name: 'N°inventaire', type: 'number', default: 0 }
                ]
            },
            'T_Departs': {
                title: 'Départs',
                idPrefix: 'DE',
                cols: [
                    { name: 'N° Départ', type: 'number', readonly: true },
                    { name: 'Date', type: 'date' },
                    { name: 'Nombre de b...', type: 'number' },
                    { name: 'Poids', type: 'number' },
                    { name: 'Produit', type: 'text' },
                    { name: 'Montant', type: 'number', default: 0 }
                ]
            },
            'T_Incidents': {
                title: 'Incidents',
                idPrefix: 'IN',
                cols: [
                    { name: 'N° Incident', type: 'number', readonly: true },
                    { name: 'Date', type: 'date' },
                    { name: 'N° Client', type: 'number' },
                    { name: 'Client', type: 'select', optionsTable: 'T_Clients', optionLabelIndex: 1 },
                    { name: 'Retours MP', type: 'checkbox' },
                    { name: 'Type de remontée', type: 'text' },
                    { name: 'Commentaires', type: 'textarea' }
                ]
            }
        };

        let currentModalState = { tableName: null, rowIndex: null, data: null };
        let cachedData = {};

        /**
         * AUTH & SSO SILENT
         */
        async function initAuth() {
            try {
                const accounts = myMSALObj.getAllAccounts();
                if (accounts.length > 0) {
                    await handleUserAccount(accounts[0]);
                } else {
                    try {
                        const silentRes = await myMSALObj.ssoSilent(loginRequest);
                        await handleUserAccount(silentRes.account);
                    } catch (err) {
                        console.warn("SSO Silent failed:", err);
                        showLoginUI();
                    }
                }
            } catch (error) {
                console.error("Init Auth Error:", error);
                showLoginUI();
            } finally {
                hideLoading();
            }
        }

        async function signIn() {
            try {
                const loginResponse = await myMSALObj.loginPopup(loginRequest);
                await handleUserAccount(loginResponse.account);
            } catch (error) {
                if (error.errorCode !== "user_cancelled") showToast("Erreur d'authentification", "error");
            }
        }

        function signOut() {
            const logoutRequest = { account: myMSALObj.getAllAccounts()[0] };
            myMSALObj.logoutPopup(logoutRequest);
        }

        async function handleUserAccount(account) {
            document.getElementById("username").innerText = account.username;
            document.getElementById("user-info").classList.remove("hidden");
            document.getElementById("login-btn").classList.add("hidden");
            document.getElementById("app-content").classList.remove("hidden");

            await resolveSiteAndWorkbook();
            loadDashboard();
        }

        async function resolveSiteAndWorkbook() {
            try {
                const token = await getToken();
                const siteRes = await fetch(`https://graph.microsoft.com/v1.0/sites/${SITE_PATH}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!siteRes.ok) throw new Error("Site introuvable.");
                const siteData = await siteRes.json();

                const fileName = FILE_PATH.split('/').pop();
                const searchRes = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteData.id}/drive/root/search(q='${fileName}')`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const searchData = await searchRes.json();
                const file = searchData.value.find(item => item.name === fileName);
                if (!file) throw new Error(`Le fichier "${fileName}" est introuvable.`);

                resolvedGraphBaseUrl = `https://graph.microsoft.com/v1.0/sites/${siteData.id}/drive/items/${file.id}/workbook`;
                console.log("Graph URL:", resolvedGraphBaseUrl);
            } catch (err) {
                showToast("Erreur SharePoint: " + err.message, "error");
            }
        }

        async function getToken() {
            const accounts = myMSALObj.getAllAccounts();
            if (accounts.length === 0) return null;
            const request = { scopes: loginRequest.scopes, account: accounts[0] };
            try {
                const res = await myMSALObj.acquireTokenSilent(request);
                return res.accessToken;
            } catch (err) {
                return (await myMSALObj.acquireTokenPopup(request)).accessToken;
            }
        }

        /**
         * DATA CORE
         */
        async function loadDashboard() {
            if (!resolvedGraphBaseUrl) return;
            // Load the current tab
            const activeTab = document.querySelector('.tab-pane:not(.hidden)');
            if (activeTab) {
                const suffix = activeTab.id.split('-')[1]; // e.g. "ramasses"
                const tableName = Object.keys(TABLE_CONFIG).find(k => k.toLowerCase().includes(suffix));
                if (tableName) loadTableData(tableName);
            }
        }

        async function loadTableData(tableName) {
            if (!resolvedGraphBaseUrl) return;
            try {
                const token = await getToken();
                const res = await fetch(`${resolvedGraphBaseUrl}/tables/${tableName}/rows`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Erreur lors de la récupération des données.");
                const data = await res.json();
                cachedData[tableName] = data.value;
                renderTable(tableName, data.value);
            } catch (err) {
                console.error(err);
                showToast(`Erreur (${tableName}): ` + err.message, "error");
            }
        }

        function renderTable(tableName, rows) {
            const config = TABLE_CONFIG[tableName];
            const suffix = tableName.split('_')[1].toLowerCase();
            const head = document.getElementById(`table-head-${suffix}`);
            const body = document.getElementById(`table-body-${suffix}`);

            if (!head || !body) return;

            // Header
            head.innerHTML = config.cols.map(c => `
                <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400 tracking-tighter">${c.name}</th>
            `).join('') + '<th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400 tracking-tighter text-right">Actions</th>';

            // Body
            body.innerHTML = '';
            if (!rows || rows.length === 0) {
                body.innerHTML = `<tr><td colspan="${config.cols.length + 1}" class="px-6 py-12 text-center text-slate-400 italic">Aucune donnée trouvée</td></tr>`;
                return;
            }

            // Show last 50 rows for performance, reversed
            const displayRows = [...rows].reverse().slice(0, 50);

            displayRows.forEach((row, idx) => {
                const originalIdx = rows.length - 1 - idx;
                const vals = row.values[0];
                const tr = document.createElement("tr");
                tr.className = "hover:bg-slate-50/50 transition-colors";

                let cellsContent = config.cols.map((col, cIdx) => {
                    let val = vals[cIdx] || '';
                    if (col.type === 'checkbox') {
                        const isChecked = val === true || val === 'VRAI' || val === 'TRUE';
                        return `<td class="px-6 py-4"><span class="w-5 h-5 rounded-md flex items-center justify-center ${isChecked ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-300'}">
                            ${isChecked ? '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg>' : ''}
                        </span></td>`;
                    }
                    if (col.type === 'date' && val) {
                        try {
                            const date = new Date((val - 25569) * 86400 * 1000); // Excel date to JS
                            val = isNaN(date.getTime()) ? val : date.toLocaleDateString('fr-FR');
                        } catch (e) { }
                    }
                    return `<td class="px-6 py-4 font-medium text-slate-700 whitespace-nowrap">${val}</td>`;
                }).join('');

                tr.innerHTML = cellsContent + `
                    <td class="px-6 py-4 text-right space-x-2 whitespace-nowrap">
                        <button onclick="openModal('${tableName}', ${originalIdx})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button onclick="deleteEntry('${tableName}', ${originalIdx})" class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        /**
         * MODAL LOGIC
         */
        async function openModal(tableName, rowIndex = null) {
            const config = TABLE_CONFIG[tableName];
            currentModalState = { tableName, rowIndex, data: rowIndex !== null ? cachedData[tableName][rowIndex].values[0] : null };

            document.getElementById("modal-title").innerText = rowIndex !== null ? "Modifier l'entrée" : "Nouvelle entrée";
            document.getElementById("modal-subtitle").innerText = config.title;

            const form = document.getElementById("dynamic-form");
            form.innerHTML = '';

            for (let i = 0; i < config.cols.length; i++) {
                const col = config.cols[i];
                let val = currentModalState.data ? currentModalState.data[i] : (col.default !== undefined ? col.default : '');

                const wrapper = document.createElement("div");
                wrapper.className = "space-y-2";

                const label = `<label class="text-[10px] font-black uppercase text-slate-400 tracking-widest pl-1">${col.name}</label>`;
                let input = '';

                if (col.type === 'checkbox') {
                    const isChecked = val === true || val === 'VRAI' || val === 'TRUE';
                    input = `<div class="flex items-center gap-3 bg-slate-50 p-4 rounded-2xl ring-1 ring-slate-200">
                                <input type="checkbox" name="col_${i}" ${isChecked ? 'checked' : ''} class="w-5 h-5 text-blue-600 rounded-lg border-slate-300 focus:ring-blue-500">
                                <span class="text-sm font-bold text-slate-600">Activé / Vrai</span>
                             </div>`;
                } else if (col.type === 'select') {
                    input = `<select name="col_${i}" class="w-full bg-slate-50 border-0 p-4 rounded-2xl ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-700">
                                <option value="">Chargement...</option>
                             </select>`;
                } else if (col.type === 'textarea') {
                    input = `<textarea name="col_${i}" rows="3" class="w-full bg-slate-50 border-0 p-4 rounded-2xl ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-700">${val}</textarea>`;
                } else if (col.type === 'date') {
                    // Convert Excel serial to YYYY-MM-DD for input[type=date] if editing
                    let dateStr = '';
                    if (val && !isNaN(val)) {
                        const d = new Date((val - 25569) * 86400 * 1000);
                        dateStr = d.toISOString().split('T')[0];
                    } else if (!val && rowIndex === null) {
                        dateStr = new Date().toISOString().split('T')[0];
                    } else {
                        dateStr = val;
                    }
                    input = `<input type="date" name="col_${i}" value="${dateStr}" class="w-full bg-slate-50 border-0 p-4 rounded-2xl ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-700">`;
                } else {
                    input = `<input type="${col.type}" name="col_${i}" value="${val}" ${col.readonly ? 'readonly' : ''} class="w-full bg-slate-50 border-0 p-4 rounded-2xl ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-700 ${col.readonly ? 'opacity-50' : ''}">`;
                }

                wrapper.innerHTML = label + input;
                form.appendChild(wrapper);

                // Populate selects
                if (col.type === 'select') {
                    const select = wrapper.querySelector('select');
                    populateSelect(select, col.optionsTable, col.optionLabelIndex, val);
                }
            }

            document.getElementById("crud-modal").classList.remove("hidden");
        }

        async function populateSelect(select, tableName, labelIdx, selectedVal) {
            if (!cachedData[tableName]) await loadTableData(tableName);
            const rows = cachedData[tableName] || [];
            select.innerHTML = '<option value="">Choisir...</option>';
            rows.forEach(r => {
                const label = r.values[0][labelIdx];
                const opt = document.createElement("option");
                opt.value = label;
                opt.textContent = label;
                if (label === selectedVal) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function closeModal() {
            document.getElementById("crud-modal").classList.add("hidden");
        }

        async function saveEntry() {
            const { tableName, rowIndex } = currentModalState;
            const config = TABLE_CONFIG[tableName];
            const btn = document.getElementById("modal-save-btn");
            const form = document.getElementById("dynamic-form");
            const fd = new FormData(form);

            btn.disabled = true;
            btn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;

            try {
                const token = await getToken();
                let values = [];
                for (let i = 0; i < config.cols.length; i++) {
                    const col = config.cols[i];
                    let val = fd.get(`col_${i}`);
                    if (col.type === 'checkbox') val = form.querySelector(`[name="col_${i}"]`).checked;
                    if (col.type === 'number') val = parseFloat(val) || 0;

                    // Auto-calc for ID on new entries
                    if (col.name.includes('N°') && rowIndex === null && i === 0) {
                        const rows = cachedData[tableName] || [];
                        const ids = rows.map(r => parseInt(r.values[0][0])).filter(id => !isNaN(id));
                        val = ids.length > 0 ? Math.max(...ids) + 1 : 1;
                        if (tableName === 'T_Ramasses' && ids.length === 0) val = 104000;
                    }

                    values.push(val);
                }

                let res;
                if (rowIndex === null) {
                    // Create
                    res = await fetch(`${resolvedGraphBaseUrl}/tables/${tableName}/rows`, {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ values: [values] })
                    });
                } else {
                    // Update - Graph API doesn't support easy PATCH for a whole row by index directly without range
                    // We need to target the specific row range address
                    const rowAddressRes = await fetch(`${resolvedGraphBaseUrl}/tables/${tableName}/rows/itemAt(index=${rowIndex})`, {
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                    const rowData = await rowAddressRes.json();
                    const rangeAddress = rowData.address.split('!')[1]; // e.g. "A10:O10"

                    res = await fetch(`${resolvedGraphBaseUrl}/worksheets/itemAt(index=0)/range(address='${rangeAddress}')`, {
                        method: "PATCH",
                        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ values: [values] })
                    });
                    // Note: This logic assumes worksheet 0.site resolved Workbook is safer.
                }

                if (res.ok) {
                    showToast("Enregistré avec succès ✅", "success");
                    closeModal();
                    loadTableData(tableName);
                } else {
                    const err = await res.json();
                    throw new Error(err.error.message);
                }
            } catch (err) {
                showToast("Erreur: " + err.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = "Enregistrer";
            }
        }

        async function deleteEntry(tableName, rowIndex) {
            if (!confirm("Êtes-vous sûr de vouloir supprimer cette ligne ?")) return;
            try {
                const token = await getToken();
                // Get the range address first to be safe, or use the rows/delete api if available
                const res = await fetch(`${resolvedGraphBaseUrl}/tables/${tableName}/rows/itemAt(index=${rowIndex})`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (res.status === 204 || res.ok) {
                    showToast("Supprimé avec succès", "success");
                    loadTableData(tableName);
                } else {
                    const err = await res.json();
                    throw new Error(err.error.message);
                }
            } catch (err) {
                showToast("Erreur lors de la suppression: " + err.message, "error");
            }
        }

        /**
         * UI UTILS
         */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('text-slate-400');
            });
            const btnId = 'btn-' + tabId.split('-')[1];
            document.getElementById(btnId).classList.add('tab-active');
            document.getElementById(btnId).classList.remove('text-slate-400');

            // Load data for the new tab
            const suffix = tabId.split('-')[1]; // clients, ramasses...
            const tableName = Object.keys(TABLE_CONFIG).find(k => k.toLowerCase().includes(suffix));
            if (tableName) loadTableData(tableName);
        }

        function showToast(msg, type) {
            const container = document.getElementById("toast-container");
            const div = document.createElement("div");
            const color = type === "success" ? "bg-emerald-600" : "bg-rose-600";
            div.className = `${color} text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between transition-all duration-300 animate-in slide-in-from-bottom font-bold text-sm`;
            div.innerHTML = `<span>${msg}</span><button onclick="this.parentElement.remove()">&times;</button>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        function hideLoading() {
            const overlay = document.getElementById("loading-overlay");
            if (overlay) {
                overlay.classList.add("opacity-0");
                setTimeout(() => overlay.remove(), 500);
            }
        }

        window.onload = initAuth;
    </script>
</body>

</html>